name: Nightly Canary Promotion
permissions:
  contents: write
  packages: read

on:
  schedule:
    - cron: '0 0 * * *'  # Runs nightly from main by default
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to promote'
        required: true
        default: 'main'
        type: string
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ inputs.source_branch || 'main' }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Git
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install toml package
      run: pip install toml

    - name: Bump Version and Push
      id: promotion
      env:
        SOURCE_BRANCH: ${{ inputs.source_branch || 'main' }}
        BUMP_TYPE: ${{ inputs.bump_type || 'patch' }}
      run: |
        set -x

        echo "Promoting from branch: $SOURCE_BRANCH with bump type: $BUMP_TYPE"

        # 1. Get current version from latest git tag (global source of truth)
        latest_tag=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
        if [ -z "$latest_tag" ]; then
          # No tags yet, fall back to pyproject.toml
          current_version=$(python -c "
        import toml
        with open('pyproject.toml', 'r') as f:
            config = toml.load(f)
        print(config['tool']['poetry']['version'])
          ")
        else
          current_version="${latest_tag#v}"
        fi

        echo "Current version: $current_version (from tag: ${latest_tag:-none})"

        # 2. Bump version based on bump type
        IFS='.' read -ra VERSION_PARTS <<< "$current_version"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}

        if [ "$BUMP_TYPE" = "major" ]; then
          MAJOR=$((MAJOR + 1))
          MINOR=0
          PATCH=0
        elif [ "$BUMP_TYPE" = "minor" ]; then
          MINOR=$((MINOR + 1))
          PATCH=0
        else
          PATCH=$((PATCH + 1))
        fi

        new_version="$MAJOR.$MINOR.$PATCH"

        echo "New version: $new_version"
        echo "new_version=$new_version" >> $GITHUB_OUTPUT

        # 3. Update version files
        mkdir -p src/test_package
        echo "# This file is auto-generated by GitHub Actions" > src/test_package/version.py
        echo "# Do not modify manually" >> src/test_package/version.py
        echo "" >> src/test_package/version.py
        echo "VERSION = \"$new_version\"" >> src/test_package/version.py

        # Update pyproject.toml
        python -c "
        import toml
        with open('pyproject.toml', 'r') as f:
            config = toml.load(f)
        config['tool']['poetry']['version'] = '$new_version'
        with open('pyproject.toml', 'w') as f:
            toml.dump(config, f)
        "

        # 4. Commit and push changes back to source branch
        git add src/test_package/version.py pyproject.toml
        git commit -m "chore: update version to $new_version from $SOURCE_BRANCH"
        git push origin $SOURCE_BRANCH

    - name: Create Git Tag
      run: |
        git tag v${{ steps.promotion.outputs.new_version }}
        git push origin v${{ steps.promotion.outputs.new_version }}
